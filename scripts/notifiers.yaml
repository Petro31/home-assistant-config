# General notification engine that adds timestamps

notify:
  alias: Notify
  fields:
    format: 
      description: The timestamp format for persistent notifications & notifications.  Annoucements do not have a timestamp.
      example: "%-I:%M:%S %p"
      default: "%-I:%M:%S %p"
      selector:
        text:
          type: text
    persistent_notification:
      description: On/Off for Persistent Notifications
      default: on
      example: on
      required: false
      selector:
        boolean:
    title:
      description: Title of the persistent notification.
      example: "Title"
      default: ""
      selector:
        text:
          type: text
    message:
      description: Message to be sent/annouced.
      example: "Hello"
      required: true
      selector:
        text:
          type: text
    notify: &notify_homeowners
      description: Devices to notify.
      example: notify.mobile_app_petro
      selector:
        select:
          options:
          - label: Petro
            value: notify.mobile_app_petro
          - label: Lambo
            value: notify.mobile_app_lindsays_iphone
          - label: Home Owners
            value: notify.homeowners
  variables:
    timestamp: >
      {%- set format = format | default("%-I:%M:%S %p") %}
      {{ as_timestamp(now(), none) | timestamp_custom(format, default="???") }}
    persistent_notification: >
      {{ persistent_notification | default(true) }}
    out_notify: "{{ notify | default('notify.homeowners') }}"
    notification_data: >
      {% set ret = namespace(data=[]) %}
      {% if title | default %}
        {% set ret.data = ret.data +[('title', title)] %}
      {% endif %}
      {% if message | default %}
        {% set ret.data = ret.data +[('message', '[{}] {}'.format(timestamp, message))] %}
      {% endif %}
      {{ dict.from_keys(ret.data) or {'message': 'No Message Provided'} }}

  sequence:
  - choose:
    - conditions: "{{ persistent_notification }}"
      sequence:
      - service: persistent_notification.create
        data: "{{ notification_data }}"
  - choose:
    - conditions: "{{ out_notify.startswith('notify.') }}"
      sequence:
      - service: "{{ out_notify }}"
        data: "{{ notification_data }}"

# call frigate notification.
# a small wrapper so that I can just call a script with a different notificaiton
# id.  This is required so that I can use anchors in the automation that calls it
# otherwise home assistant stupidly bitches about recieving the same key making
# anchors useless.  

silencable_frigate_notification:
  mode: parallel
  alias: Notify - Camera Detection
  max: 20
  fields: 
    id:
      description: The frigate payload id
      example: 1234567891.123456-abcdef
    camera:
      description: The name of the camera in frigate's configuration.
      example: kitchen
    message:
      description: Message to be sent/annouced.
      example: "Hello"
  variables:
    notify: notify.mobile_app_petro
    persistent_notification: on
  sequence: 

  - variables:
      silence: silence-{{ notify | replace(".", "-") | replace("_","-") }}-{{ camera }}

  - service: script.notify_frigate
    data:
      id: '{{ id }}'
      camera: '{{ camera }}'
      message: "{{ message }}"
      notify: '{{ notify }}'
      silence: "{{ silence }}"
      persistent_notification: "{{ persistent_notification }}"

  - wait_for_trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: "{{ silence }}"
    timeout:
      seconds: 30
    continue_on_timeout: false

  - delay:
      minutes: 30

# General notification engine for frigate

notify_frigate:
  alias: Notify - Frigate
  mode: parallel
  max: 40
  fields:
    id:
      description: The frigate payload id
      example: 1234567891.123456-abcdef
      selector:
        text:
          type: text
    camera:
      description: The name of the camera in frigate's configuration.
      example: kitchen
      selector:
        text:
          type: text
    silence:
      description: The action that will silence the notification.
      example: silence-notify-mobile-app-petro-kitchen
      selector:
        text:
          type: text
    format: 
      description: The timestamp format for persistent notifications & notifications.  Annoucements do not have a timestamp.
      example: "%-I:%M:%S %p"
      selector:
        text:
          type: text
    persistent_notification:
      description: On/Off for Persistent Notifications
      example: on
      default: on
      selector:
        boolean:
    title:
      description: Title of the persistent notification.
      example: "Title"
      selector:
        text:
          type: text
    message:
      description: Message to be sent/annouced.
      example: "Hello"
      selector:
        text:
          type: text
    notify: *notify_homeowners
  variables:
    tag: >
      {{ id }}
    group: >
      frigate-notification-{{ camera }}
    image: >
      /api/frigate/notifications/{{ id }}/thumbnail.jpg?format=android
    thumbnail: >
      /api/frigate/notifications/{{ id }}/thumbnail.jpg
    base_url: !secret external_url
    video: >
      {{ base_url }}/api/frigate/notifications/{{ id }}/{{ camera }}/clip.mp4
    snapshot: >
      {{ base_url }}/api/frigate/notifications/{{ id }}/snapshot.jpg
    timestamp: >
      {%- set format = format | default("%-I:%M:%S %p") %}
      {{ as_timestamp(now(), none) | timestamp_custom(format, default="???") }}
    persistent_notification: >
      {{ persistent_notification | default(true) }}
    out_notify: "{{ notify | default('notify.homeowners') }}"
    out_title: >
      {{ title | default('') }}
    out_message: >
      {%- set message = message | default('No Message Provided') %}
      {{ '[{}] {}'.format(timestamp, message) }}
  sequence:
  # Initial Message
  - choose:
    - conditions: "{{ persistent_notification }}"
      sequence:
      - service: persistent_notification.create
        data:
          message: >
            {{ out_message }}
            ![image]({{ image }})
  - condition: template
    value_template: "{{ out_notify.startswith('notify.') }}"
  - service: "{{ out_notify }}"
    data:
      message: "{{ out_message }}"
      data:
        tag: '{{ tag }}'
        group: '{{ group }}'
        image: '{{ image }}'
        attachment:
          url: "{{ thumbnail }}"

    # Each clip
  - repeat:
      sequence:
      - wait_for_trigger:
        - platform: mqtt
          topic: frigate/events
          payload: '{{ id }}'
          value_template: '{{ value_json.after.id }}'
        timeout:
          minutes: 2
        continue_on_timeout: false
      - condition: template
        value_template: '{{ wait.trigger and wait.trigger.payload_json.type == "end" }}'
      - choose:
        - conditions: "{{ persistent_notification }}"
          sequence:
          - service: persistent_notification.create
            data:
              message: >
                {{ out_message }}
                
                ![image]({{ image }})

                [Click here to view clip]({{ video }})
      - service: "{{ out_notify }}"
        data:
          message: "{{ out_message }}"
          data:
            tag: "{{ tag }}"
            group: "{{ group }}"
            url: "{{ video }}"
            clickAction: "{{ video }}"
            image: "{{ image }}"
            sound: none
            attachment:
              url: "{{ thumbnail }}"
            actions:
            - action: URI
              title: View Clip
              uri: "{{ video }}"
            - action: URI
              title: View Snapshot
              uri: "{{ snapshot }}"
            - action: "{{ silence }}"
              title: Silence Notifications
              destructive: true
      until: '{{ wait.trigger and wait.trigger.payload_json.type == "end" }}'
